name: ğŸš€ Deploy Backend to AWS EC2

on:
  push:
    branches:
      - main  # Deploy automatically when code is pushed to main branch

permissions:
  contents: read  # Required for using ${{ github.token }} to clone repo

jobs:
  deploy:
    name: Backend Deployment
    runs-on: ubuntu-24.04

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      NODE_ENV: production

    steps:
      # ğŸ› ï¸ Step 1: Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸŸ¢ Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ğŸ“¦ Step 3: Install dependencies (clean install)
      - name: Install dependencies
        run: npm ci

      # ğŸ§¹ Step 4: Run syntax validation
      - name: Syntax validation
        run: |
          echo "ğŸ” Checking Node.js syntax..."
          node --check index.js

      # ğŸš€ Step 5: Deploy to EC2 via SSH
      - name: Deploy application to EC2
        run: |
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem

          echo "ğŸ” Connecting to EC2 and deploying..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            echo "ğŸš€ Deployment started on EC2..."

            # Create or go to app directory
            sudo mkdir -p /var/www/epi-backend
            sudo chown ubuntu:ubuntu /var/www/epi-backend
            cd /var/www/epi-backend

            echo "ğŸ§¹ Cleaning up temporary files to free space..."
            sudo rm -rf /tmp/* || true
            sudo journalctl --vacuum-time=3d || true
            echo "âœ… Cleanup completed"

            # Clean or update deployment folder
            if [ -d .git ]; then
              echo "ğŸ”„ Existing repo found â€” pulling latest changes..."
              git fetch origin main
              git reset --hard origin/main
            elif [ "\$(ls -A .)" ]; then
              echo "âš ï¸ Existing non-git folder found â€” clearing and recloning..."
              rm -rf *
              git clone https://x-access-token:${{ github.token }}@github.com/nabeelanasaritsaoirse/epi-backend.git .
            else
              echo "ğŸ“¦ Cloning repository for the first time..."
              git clone https://x-access-token:${{ github.token }}@github.com/nabeelanasaritsaoirse/epi-backend.git .
            fi

            echo "ğŸ“¦ Installing dependencies..."
            npm ci --omit=dev

            echo "âš™ï¸ Writing environment variables..."
            cat <<EOT > .env
              PORT=5000
              MONGODB_URI=${{ secrets.MONGODB_URI }}
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
              FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
              FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}
              RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
              RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
              EOT

            echo "ğŸš¦ Restarting PM2 process..."
            pm2 restart epi-backend || pm2 start npm --name "epi-backend" -- start
            pm2 save

            echo "âœ… Deployment completed successfully!"
          EOF

      # ğŸ§¾ Step 6: Add deployment summary
      - name: Deployment summary
        if: success()
        run: |
          echo "## âœ… Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **User:** ${{ secrets.EC2_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Process:** epi-backend" >> $GITHUB_STEP_SUMMARY
          echo "- **Port:** 5000" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully deployed via GitHub Actions ğŸš€" >> $GITHUB_STEP_SUMMARY
