name: Deploy Node.js Backend to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-24.04

    env:
      NODE_ENV: production
      AWS_REGION: ap-south-1
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run lint check
        run: |
          echo "Running lint check..."
          npx eslint . || echo "‚ö†Ô∏è Lint warnings detected, continuing deployment"

      - name: Run basic syntax test
        run: |
          echo "Performing syntax validation..."
          node --check index.js
          echo "‚úÖ Node.js syntax validation passed"

      - name: Deploy backend to EC2
        run: |
          echo "Deploying to EC2 instance..."
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e
            echo "üì¶ Pulling latest code..."
            cd /var/www/epi-backend || exit 1
            git fetch origin main
            git reset --hard origin/main

            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev

            echo "üîÑ Restarting backend service with PM2..."
            pm2 restart epi-backend || pm2 start npm --name "epi-backend" -- start
            pm2 save

            echo "‚úÖ Deployment completed successfully!"
          EOF

      - name: Add Deployment Summary
        if: success()
        run: |
          echo "## ‚úÖ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** Epi Backend" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** AWS EC2 (${AWS_REGION})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Host:** http://${{ env.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployed successfully via GitHub Actions" >> $GITHUB_STEP_SUMMARY

      # # üí¨ Notify Microsoft Teams (Success)
      # - name: Notify Teams on Success
      #   if: success()
      #   uses: skitionek/notify-microsoft-teams@v2
      #   with:
      #     webhook_url: ${{ env.TEAMS_WEBHOOK_URL }}
      #     job: ${{ toJson(job) }}
      #     needs: ${{ toJson(needs) }}
      #     overwrite: |
      #       title: ‚úÖ Epi Backend Deployment Successful
      #       text: |
      #         **Application:** Epi Backend  
      #         **Environment:** AWS EC2  
      #         **Branch:** main  
      #         **Host:** http://${{ env.EC2_HOST }}  
      #         ‚úÖ Deployment completed successfully!

      # # ‚ùå Notify Microsoft Teams (Failure)
      # - name: Notify Teams on Failure
      #   if: failure()
      #   uses: skitionek/notify-microsoft-teams@v2
      #   with:
      #     webhook_url: ${{ env.TEAMS_WEBHOOK_URL }}
      #     job: ${{ toJson(job) }}
      #     needs: ${{ toJson(needs) }}
      #     overwrite: |
      #       title: ‚ùå Epi Backend Deployment Failed
      #       text: |
      #         **Application:** Epi Backend  
      #         **Environment:** AWS EC2  
      #         **Branch:** main  
      #         ‚ö†Ô∏è Check GitHub Actions logs for details.
