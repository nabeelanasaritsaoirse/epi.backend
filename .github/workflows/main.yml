name:  Deploy Backend to AWS EC2
run-name: "üöÄ Deployment triggered by ${{ github.actor }} on branch ${{ github.ref_name }}"

on:
  push:
    branches:
      - main 
      
permissions:
  contents: write   # Required for tagging new releases
  issues: read
  pull-requests: read

jobs:
  deploy:
    name: Backend Deployment
    runs-on: ubuntu-24.04

    concurrency:
      group: deploy-epi
      cancel-in-progress: true
          
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      EC2_GITHUB_DEPLOY_KEY: ${{ secrets.EC2_GITHUB_DEPLOY_KEY }}
      NODE_ENV: production

    steps:
      #  Step 1: Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies (auto-fallback)
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci || {
            echo "‚ö†Ô∏è npm ci failed ‚Äî falling back to npm install..."
            npm install
          }
          
      # - name: Run semantic-release
      #   id: version
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     npx semantic-release --branches main --no-ci || echo "No release needed"

      # # ‚úÖ Step 4: Linting check (ESLint)
      # - name: Run ESLint
      #   run: |
      #     echo "üßπ Running ESLint..."
      #     npx eslint . --ext .js,.mjs,.cjs || {
      #       echo "‚ùå ESLint found issues!"
      #       exit 1
      #     }

      # # ‚úÖ Step 5: Run tests
      # - name: Run Tests
      #   run: |
      #     echo "üß™ Running test suite..."
      #     npm test || {
      #       echo "‚ùå Tests failed!"
      #       exit 1
      #     }

      #  Step 6: Syntax validation
      - name: Syntax validation
        run: |
          echo "üîç Checking Node.js syntax..."
          node --check index.js

      - name: Create SSH Private Key
        run: |
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
          
      - name: Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} "echo connected"

    
      #  Step 7: Deploy to EC2 via SSH
      - name: üöÄ Deploy application to EC2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
      
          echo "Connecting to EC2 and deploying..."
      
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << EOF
          set -e
          echo "üöÄ Deployment started on EC2..."
      
          # Ensure project directory exists
          sudo mkdir -p /var/www/epi-backend
          sudo chown ubuntu:ubuntu /var/www/epi-backend
          cd /var/www/epi-backend
      
          # Pull latest code using HTTPS
          echo "üîÑ Pulling latest code..."
          git config --global credential.helper store
          echo "https://${GITHUB_TOKEN}:x-oauth-basic@github.com" > ~/.git-credentials
      
          if [ -d .git ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone https://${GITHUB_TOKEN}:x-oauth-basic@github.com/nabeelanasaritsaoirse/epi.backend.git .
          fi
      
          # Cleanup
          echo "üßπ Cleaning up..."
          sudo rm -rf /tmp/* || true
          sudo journalctl --vacuum-time=3d || true
      
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --omit=dev
          
          echo "üßæ Writing environment variables..."
          cat > .env << ENVEND
          PORT=5000
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=ap-south-1
          AWS_BUCKET_NAME=company-video-storage-prod
          ENVEND
          echo "üîÅ Restarting PM2..."
          pm2 describe epi-backend >/dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            pm2 restart epi-backend --update-env || true
          else
            pm2 start index.js --name epi-backend || true
          fi

          pm2 save
          pm2 save
          echo "-------------------------------------"
          echo "‚úÖ Deployment completed successfully!"
          echo "-------------------------------------"
          EOF
          echo "üåê Your API is live at: https://api.epielio.com"

          
      - name: üßæ Add summary with clickable links
        if: success()
        run: |
          echo "## üöÄ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**üîπ API Domain (GoDaddy DNS):**" >> $GITHUB_STEP_SUMMARY
          echo "[https://api.epielio.com](https://api.epielio.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
  
          echo "**üîπ PM2 Process Status:**" >> $GITHUB_STEP_SUMMARY
          echo "\`pm2 status epi-backend\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
  
          echo "‚úÖ Backend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY


    # # ‚úÖ Send Email on Success
    #   - name: Send Email (Success)
    #     if: success()
    #     uses: dawidd6/action-send-mail@v3
    #     with:
    #       server_address: smtp.gmail.com
    #       server_port: 465
    #       secure: true
    #       username: ${{ secrets.EMAIL_USERNAME }}
    #       password: ${{ secrets.EMAIL_PASSWORD }}
    #       subject: "‚úÖ EPI Backend Deployment Successful"
    #       body: |
    #         üéâ The backend has been successfully deployed to AWS EC2.
      
    #         **Details:**
    #         - Host: ${{ secrets.EC2_HOST }}
    #         - User: ${{ secrets.EC2_USER }}
    #         - Environment: Production
    #         - Commit: ${{ github.sha }}
    #         - Repository: ${{ github.repository }}
    #         - Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
    #         üöÄ Deployment completed successfully via GitHub Actions!
    #       to: "nabeelanasarit.saoirse@gmail.com"
    #       from: ${{ secrets.EMAIL_USERNAME }}
    #       nodemailerdebug: true
      
    #   # ‚ùå Send Email on Failure
    #   - name: Send Email (Failure)
    #     if: failure()
    #     uses: dawidd6/action-send-mail@v3
    #     with:
    #       server_address: smtp.gmail.com
    #       server_port: 465
    #       secure: true
    #       username: ${{ secrets.EMAIL_USERNAME }}
    #       password: ${{ secrets.EMAIL_PASSWORD }}
    #       subject: "‚ùå EPI Backend Deployment Failed"
    #       body: |
    #         ‚ö†Ô∏è The backend deployment to AWS EC2 has failed.
      
    #         **Details:**
    #         - Host: ${{ secrets.EC2_HOST }}
    #         - User: ${{ secrets.EC2_USER }}
    #         - Branch: ${{ github.ref }}
    #         - Commit: ${{ github.sha }}
    #         - Workflow: ${{ github.workflow }}
    #         - Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
    #         Please review the logs in GitHub Actions to identify the issue.
    #       to: "nabeelanasarit.saoirse@gmail.com"
    #       from: ${{ secrets.EMAIL_USERNAME }}
    #       nodemailerdebug: true
